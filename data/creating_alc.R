#Script for data wrangling in week3, Kiira MÃ¤klin, 10.11.2020

#Loading the data files
por <- read.table("student-por.csv", sep = ";", header=TRUE)
math <- read.table("student-mat.csv", sep = ";", header=TRUE)

#Observing the data sets
head(por, n=3)
#  school sex age address famsize Pstatus Medu Fedu     Mjob     Fjob     reason guardian traveltime studytime failures schoolsup
#1     GP   F  18       U     GT3       A    4    4  at_home  teacher     course   mother          2         2        0       yes
#2     GP   F  17       U     GT3       T    1    1  at_home    other     course   father          1         2        0        no
#3     GP   F  15       U     LE3       T    1    1  at_home    other      other   mother          1         2        0       yes
#famsup paid activities nursery higher internet romantic famrel freetime goout Dalc Walc health absences G1 G2 G3
#1     no   no         no     yes    yes       no       no      4        3     4    1    1      3        4  0 11 11
#2    yes   no         no      no    yes      yes       no      5        3     3    1    1      3        2  9 11 11
#3     no   no         no     yes    yes      yes       no      4        3     2    2    3      3        6 12 13 12

str(por)
#'data.frame':	649 obs. of  33 variables:
#$ school    : chr  "GP" "GP" "GP" "GP" ...
#$ sex       : chr  "F" "F" "F" "F" ...
#$ age       : int  18 17 15 15 16 16 16 17 15 15 ...
#$ address   : chr  "U" "U" "U" "U" ...
#$ famsize   : chr  "GT3" "GT3" "LE3" "GT3" ...
#$ Pstatus   : chr  "A" "T" "T" "T" ...
#$ Medu      : int  4 1 1 4 3 4 2 4 3 3 ...
#$ Fedu      : int  4 1 1 2 3 3 2 4 2 4 ...
#$ Mjob      : chr  "at_home" "at_home" "at_home" "health" ...
#$ Fjob      : chr  "teacher" "other" "other" "services" ...
#$ reason    : chr  "course" "course" "other" "home" ...
#$ guardian  : chr  "mother" "father" "mother" "mother" ...
#$ traveltime: int  2 1 1 1 1 1 1 2 1 1 ...
#$ studytime : int  2 2 2 3 2 2 2 2 2 2 ...
#$ failures  : int  0 0 0 0 0 0 0 0 0 0 ...
#$ schoolsup : chr  "yes" "no" "yes" "no" ...
#$ famsup    : chr  "no" "yes" "no" "yes" ...
#$ paid      : chr  "no" "no" "no" "no" ...
#$ activities: chr  "no" "no" "no" "yes" ...
#$ nursery   : chr  "yes" "no" "yes" "yes" ...
#$ higher    : chr  "yes" "yes" "yes" "yes" ...
#$ internet  : chr  "no" "yes" "yes" "yes" ...
#$ romantic  : chr  "no" "no" "no" "yes" ...
#$ famrel    : int  4 5 4 3 4 5 4 4 4 5 ...
#$ freetime  : int  3 3 3 2 3 4 4 1 2 5 ...
#$ goout     : int  4 3 2 2 2 2 4 4 2 1 ...
#$ Dalc      : int  1 1 2 1 1 1 1 1 1 1 ...
#$ Walc      : int  1 1 3 1 2 2 1 1 1 1 ...
#$ health    : int  3 3 3 5 5 5 3 1 1 5 ...
#$ absences  : int  4 2 6 0 0 6 0 2 0 0 ...
#$ G1        : int  0 9 12 14 11 12 13 10 15 12 ...
#$ G2        : int  11 11 13 14 13 12 12 13 16 12 ...
#$ G3        : int  11 11 12 14 13 13 13 13 17 13 ...

dim(por)
#[1] 649  33

head(math, n=3)
#school sex age address famsize Pstatus Medu Fedu     Mjob     Fjob     reason guardian traveltime studytime failures schoolsup
#1     GP   F  18       U     GT3       A    4    4  at_home  teacher     course   mother          2         2        0       yes
#2     GP   F  17       U     GT3       T    1    1  at_home    other     course   father          1         2        0        no
#3     GP   F  15       U     LE3       T    1    1  at_home    other      other   mother          1         2        3       yes
#famsup paid activities nursery higher internet romantic famrel freetime goout Dalc Walc health absences G1 G2 G3
#1     no   no         no     yes    yes       no       no      4        3     4    1    1      3        6  5  6  6
#2    yes   no         no      no    yes      yes       no      5        3     3    1    1      3        4  5  5  6
#3     no  yes         no     yes    yes      yes       no      4        3     2    2    3      3       10  7  8 10

str(math)
#'data.frame':	395 obs. of  33 variables:
#$ school    : chr  "GP" "GP" "GP" "GP" ...
#$ sex       : chr  "F" "F" "F" "F" ...
#$ age       : int  18 17 15 15 16 16 16 17 15 15 ...
#$ address   : chr  "U" "U" "U" "U" ...
#$ famsize   : chr  "GT3" "GT3" "LE3" "GT3" ...
#$ Pstatus   : chr  "A" "T" "T" "T" ...
#$ Medu      : int  4 1 1 4 3 4 2 4 3 3 ...
#$ Fedu      : int  4 1 1 2 3 3 2 4 2 4 ...
#$ Mjob      : chr  "at_home" "at_home" "at_home" "health" ...
#$ Fjob      : chr  "teacher" "other" "other" "services" ...
#$ reason    : chr  "course" "course" "other" "home" ...
#$ guardian  : chr  "mother" "father" "mother" "mother" ...
#$ traveltime: int  2 1 1 1 1 1 1 2 1 1 ...
#$ studytime : int  2 2 2 3 2 2 2 2 2 2 ...
#$ failures  : int  0 0 3 0 0 0 0 0 0 0 ...
#$ schoolsup : chr  "yes" "no" "yes" "no" ...
#$ famsup    : chr  "no" "yes" "no" "yes" ...
#$ paid      : chr  "no" "no" "yes" "yes" ...
#$ activities: chr  "no" "no" "no" "yes" ...
#$ nursery   : chr  "yes" "no" "yes" "yes" ...
#$ higher    : chr  "yes" "yes" "yes" "yes" ...
#$ internet  : chr  "no" "yes" "yes" "yes" ...
#$ romantic  : chr  "no" "no" "no" "yes" ...
#$ famrel    : int  4 5 4 3 4 5 4 4 4 5 ...
#$ freetime  : int  3 3 3 2 3 4 4 1 2 5 ...
#$ goout     : int  4 3 2 2 2 2 4 4 2 1 ...
#$ Dalc      : int  1 1 2 1 1 1 1 1 1 1 ...
#$ Walc      : int  1 1 3 1 2 2 1 1 1 1 ...
#$ health    : int  3 3 3 5 5 5 3 1 1 5 ...
#$ absences  : int  6 4 10 2 4 10 0 6 0 0 ...
#$ G1        : int  5 5 7 15 6 15 12 6 16 14 ...
#$ G2        : int  6 5 8 14 10 15 12 5 18 15 ...
#$ G3        : int  6 6 10 15 10 15 11 6 19 15 ...
dim(math)
#[1] 395  33

# Continuing with Reijo's code: 
#Define own id for both datasets

library(dplyr)
por_id <- por %>% mutate(id=1000+row_number()) 
math_id <- math %>% mutate(id=2000+row_number())

# Which columns vary in datasets
free_cols <- c("id","failures","paid","absences","G1","G2","G3")

# The rest of the columns are common identifiers used for joining the datasets
join_cols <- setdiff(colnames(por_id),free_cols)

pormath_free <- por_id %>% bind_rows(math_id) %>% select(one_of(free_cols))

# Combine datasets to one long data
#   NOTE! There are NO 382 but 370 students that belong to both datasets
#         Original joining/merging example is erroneous!
pormath <- por_id %>% 
  bind_rows(math_id) %>%
  # Aggregate data (more joining variables than in the example)  
  group_by(.dots=join_cols) %>%  
  # Calculating required variables from two obs  
  summarise(                                                           
    n=n(),
    id.p=min(id),
    id.m=max(id),
    failures=round(mean(failures)),     #  Rounded mean for numerical
    paid=first(paid),                   #    and first for chars
    absences=round(mean(absences)),
    G1=round(mean(G1)),
    G2=round(mean(G2)),
    G3=round(mean(G3))    
  ) %>%
  # Remove lines that do not have exactly one obs from both datasets
  #   There must be exactly 2 observations found in order to joining be succesful
  #   In addition, 2 obs to be joined must be 1 from por and 1 from math
  #     (id:s differ more than max within one dataset (649 here))
  filter(n==2, id.m-id.p>650) %>%  
  # Join original free fields, because rounded means or first values may not be relevant
  inner_join(pormath_free,by=c("id.p"="id"),suffix=c("",".p")) %>%
  inner_join(pormath_free,by=c("id.m"="id"),suffix=c("",".m")) %>%
  # Calculate other required variables  
  ungroup %>% mutate(
    alc_use = (Dalc + Walc) / 2,
    high_use = alc_use > 2,
    cid=3000+row_number()
  )

# Save created data to folder as a csv
write.csv(pormath,file="pormath.csv")

#Reading in the data and observing it
pormath <-read.csv("pormath.csv")

head(pormath, n=3)
#  X school sex age address famsize Pstatus Medu Fedu    Mjob  Fjob     reason guardian traveltime studytime schoolsup famsup
#1 1     GP   F  15       R     GT3       T    1    1 at_home other       home   mother          2         4       yes    yes
#2 2     GP   F  15       R     GT3       T    1    1   other other reputation   mother          1         2       yes    yes
#3 3     GP   F  15       R     GT3       T    2    2 at_home other reputation   mother          1         1       yes    yes
#activities nursery higher internet romantic famrel freetime goout Dalc Walc health n id.p id.m failures paid absences G1 G2 G3
#1        yes     yes    yes      yes       no      3        1     2    1    1      1 2 1096 2096        0  yes        3 10 12 12
#2         no      no    yes      yes      yes      3        3     4    2    4      5 2 1073 2073        1   no        2 10  8  8
#3        yes     yes    yes       no       no      4        3     1    1    1      2 2 1040 2040        0   no        8 14 13 12
#failures.p paid.p absences.p G1.p G2.p G3.p failures.m paid.m absences.m G1.m G2.m G3.m alc_use high_use  cid
#1          0    yes          4   13   13   13          1    yes          2    7   10   10       1    FALSE 3001
#2          0     no          2   13   11   11          2     no          2    8    6    5       3     TRUE 3002
#3          0     no          8   14   13   12          0    yes          8   14   13   13       1    FALSE 3003

str(pormath)
#'data.frame':	370 obs. of  52 variables:
#  $ X         : int  1 2 3 4 5 6 7 8 9 10 ...
#$ school    : chr  "GP" "GP" "GP" "GP" ...
#$ sex       : chr  "F" "F" "F" "F" ...
#$ age       : int  15 15 15 15 15 15 15 15 15 15 ...
#$ address   : chr  "R" "R" "R" "R" ...
#$ famsize   : chr  "GT3" "GT3" "GT3" "GT3" ...
#$ Pstatus   : chr  "T" "T" "T" "T" ...
#$ Medu      : int  1 1 2 2 3 3 3 2 3 3 ...
#$ Fedu      : int  1 1 2 4 3 4 4 2 1 3 ...
#$ Mjob      : chr  "at_home" "other" "at_home" "services" ...
#$ Fjob      : chr  "other" "other" "other" "health" ...
#$ reason    : chr  "home" "reputation" "reputation" "course" ...
#$ guardian  : chr  "mother" "mother" "mother" "mother" ...
#$ traveltime: int  2 1 1 1 2 1 2 2 2 1 ...
#$ studytime : int  4 2 1 3 3 3 3 2 4 4 ...
#$ schoolsup : chr  "yes" "yes" "yes" "yes" ...
#$ famsup    : chr  "yes" "yes" "yes" "yes" ...
#$ activities: chr  "yes" "no" "yes" "yes" ...
#$ nursery   : chr  "yes" "no" "yes" "yes" ...
#$ higher    : chr  "yes" "yes" "yes" "yes" ...
#$ internet  : chr  "yes" "yes" "no" "yes" ...
#$ romantic  : chr  "no" "yes" "no" "no" ...
#$ famrel    : int  3 3 4 4 4 4 4 4 4 4 ...
#$ freetime  : int  1 3 3 3 2 3 2 1 4 3 ...
#$ goout     : int  2 4 1 2 1 2 2 3 2 3 ...
#$ Dalc      : int  1 2 1 1 2 1 2 1 2 1 ...
#$ Walc      : int  1 4 1 1 3 1 2 3 3 1 ...
#$ health    : int  1 5 2 5 3 5 5 4 3 4 ...
#$ n         : int  2 2 2 2 2 2 2 2 2 2 ...
#$ id.p      : int  1096 1073 1040 1025 1166 1039 1131 1069 1070 1106 ...
#$ id.m      : int  2096 2073 2040 2025 2153 2039 2131 2069 2070 2106 ...
#$ failures  : int  0 1 0 0 1 0 1 0 0 0 ...
#$ paid      : chr  "yes" "no" "no" "no" ...
#$ absences  : int  3 2 8 2 5 2 0 1 9 10 ...
#$ G1        : int  10 10 14 10 12 12 11 10 16 10 ...
#$ G2        : int  12 8 13 10 12 12 6 10 16 10 ...
#$ G3        : int  12 8 12 9 12 12 6 10 16 10 ...
#$ failures.p: int  0 0 0 0 0 0 0 0 0 0 ...
#$ paid.p    : chr  "yes" "no" "no" "no" ...
#$ absences.p: int  4 2 8 2 2 2 0 0 6 10 ...
#$ G1.p      : int  13 13 14 10 13 11 10 11 15 10 ...
#$ G2.p      : int  13 11 13 11 13 12 11 10 15 10 ...
#$ G3.p      : int  13 11 12 10 13 12 12 11 15 10 ...
#$ failures.m: int  1 2 0 0 2 0 2 0 0 0 ...
#$ paid.m    : chr  "yes" "no" "yes" "yes" ...
#$ absences.m: int  2 2 8 2 8 2 0 2 12 10 ...
#$ G1.m      : int  7 8 14 10 10 12 12 8 16 10 ...
#$ G2.m      : int  10 6 13 9 10 12 0 9 16 11 ...
#$ G3.m      : int  10 5 13 8 10 11 0 8 16 11 ...
#$ alc_use   : num  1 3 1 1 2.5 1 2 2 2.5 1 ...
#$ high_use  : logi  FALSE TRUE FALSE FALSE TRUE FALSE ...
#$ cid       : int  3001 3002 3003 3004 3005 3006 3007 3008 3009 3010 ...

head(pormath)

dim(pormath)
#[1] 370  52


#Testing which variables to use in the exercise

table(pormath$high_use, pormath$sex)
#F   M
#FALSE 154 105
#TRUE   41  70

table(pormath$high_use, pormath$internet)
#no yes
#FALSE  42 217
#TRUE   15  96

table(pormath$high_use, pormath$failures)
#0   1   2   3
#FALSE 238  12   8   1
#TRUE   87  12   9   3

table(pormath$high_use, pormath$famsup)
#no yes
#FALSE  94 165
#TRUE   45  66

#Choosing sex, internet, failures and famsup

#Observing the data for the latter analysis
summary(pormath$alc_use)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#1.000   1.000   1.500   1.889   2.500   5.000

hist(pormath$alc_use)

higher <- pormath$alc_use >2

table(higher)
#FALSE  TRUE 
#259   111

summary(pormath$Dalc)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#1.000   1.000   1.000   1.484   2.000   5.000 
hist(pormath$Dalc)
head(pormath$Dalc)

summary(pormath$Walc)
#Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#1.000   1.000   2.000   2.295   3.000   5.000 
hist(pormath$Walc)
head(pormath$Walc)
